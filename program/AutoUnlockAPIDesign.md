## DVMルーン自動強化、ユーザリクエストに基づくルーン保護解除(アンロック)API設計

### 目的

+ ルーン自動強化後に、不要なルーンをアンロックし削除の手間を省きたい。
+ WebAPIを作ってみたい。

### 実現したいこと

1. 現状強化完了後に送られてくるLineの通知を利用し、この通知にAPIを叩くためのURLを追加。
2. 通知されたURLを選択（タップ、クリック）することでサーバ側はGUI操作を行い、目的のルーンの保護解除を行う。
3. 誤ったルーンを選択しない
   + おそらく保存されている画像でテンプレートマッチングすれば間違いないと思う。
     + 処理後の画像を送付かWebページに表示して確認できるようにする。
4. 可能であれば非同期（キューイング）ができることが望ましい。（1つ1つ全て待つのは面倒なので）
   + 重複処理できても良い（その場で再ロックできるのは悪いことではない）

### 必要なもの・こと

+ APIサーバ
+ どういったクエリストリングを送信すればミスが起きづらいか。
  + 多分ファイル名そのまま指定するのが最も安全。
+ ロックとアンロック両方できるようにしたいので、クエリストリングにはそれ含めても良いかも
  + > `/unlock/{GenerationNumber}`  
    > とするとパスによってロックとアンロックが分けられる。  
    > このGenerationNumberを基にチェックができる。
  + 例えば、初回強化成功時に送られてくる画像にはアンロック用のURL(?action=unlockみたいな)  
    アンロック済みの画像に添えるのはロック用のURL(?action=lock)
  + 無論そもそもURLで分けたほうが安全というのも最も。  
   （ただ、関数の大半は重複するが、受信先で引数の違いなだけで最終的に同じ関数で処理する。というのは有りかも)

### 作業工程

1. FastAPIのHelloWorld!
2. returnを返さないAPIが作成できるか（ユーザ向けの応答と内部処理向けの応答が分けられるか)
3. 簡単な操作をさせてみる
   1. 後続作業を考えてPyAutoGUIとかが良いかも
4. 単体でアンロック（ロック）できるAPIの作成
    + クエリを受け取る（ここではファイル名と座標が含まれるものを仮定する)
      + ファイル名に処理世代名を追加する
        + 処理世代はDNSと同じ。YYYYMMDDHHMMSSとかをGen-YYYYMMDDHHMMSS_日付〜見たくする。
        + 処理世代はファイルに保存する。（いつ？　処理開始時）
          + なかった時は新規作成
          + 既にあった時は上書き
    + 処理世代を確認する（過去のURLが再利用できてしまってはまずい）
    + 処理可能な世代ならば装着箇所を選択する。
      + できなければreturnでその旨伝える。
    + ソートパラメータを［強化］選択
    + ソートパラメータ［降順］を選択
    + 座標を基にPyAutoGUIでクリックする
    + 画像ファイル名に基づきテンプレートマッチングを行い一定の精度以上であればアンロック（ロック）する。
      + 動作が完了できた時は画像を取得して表示する。
5. 単体でロックできるAPIの作成（ほぼ４の引数違いな感がある)
6. ~~キューイングできるAPIの作成。~~
  後日考える。

### 詳細設計

|種類|値|備考|
|---:|:---|:---:|
|パス|/unlock|ロック解除。(既に解除されている時は何もしない)|
|パス|/lock|ロックする（既にされている時は何もしない）|
|パス|/invert|ロック状態の反転。(どのような状態でもクリックする)|
|クエリパラメータ|||
|パス|date|ファイル名の指定に利用|
|パス|pos|装着箇所の指定に利用|
|パス|x|クリックするx座標の指定に利用|
|パス|y|クリックするy座標の指定に利用|

